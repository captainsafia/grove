name: PR Build

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Set PR version
        id: version
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMIT_SHA=${GITHUB_SHA::7}
          PR_VERSION="0.0.0-pr.${PR_NUMBER}.${COMMIT_SHA}"
          echo "VERSION=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Generated PR version: ${PR_VERSION}"

      - name: Update package.json version
        run: npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      - name: Build for Linux x64
        run: bun build --compile --minify --sourcemap --target=bun-linux-x64 ./src/index.ts --outfile grove-linux-x64

      - name: Build for Linux ARM64
        run: bun build --compile --minify --sourcemap --target=bun-linux-arm64 ./src/index.ts --outfile grove-linux-arm64

      - name: Build for macOS x64
        run: bun build --compile --minify --sourcemap --target=bun-darwin-x64 ./src/index.ts --outfile grove-darwin-x64

      - name: Build for macOS ARM64
        run: bun build --compile --minify --sourcemap --target=bun-darwin-arm64 ./src/index.ts --outfile grove-darwin-arm64

      - name: Build for Windows x64
        run: bun build --compile --minify --sourcemap --target=bun-windows-x64 ./src/index.ts --outfile grove-windows-x64.exe

      - name: Upload PR executables
        uses: actions/upload-artifact@v4
        with:
          name: grove-pr-${{ steps.version.outputs.PR_NUMBER }}-${{ steps.version.outputs.VERSION }}
          path: |
            grove-linux-x64
            grove-linux-arm64
            grove-darwin-x64
            grove-darwin-arm64
            grove-windows-x64.exe
          retention-days: 30

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const version = '${{ steps.version.outputs.VERSION }}';
            const runId = context.runId;
            const body = `ðŸŒ³ **Grove PR Build Ready!**

            **Version:** \`${version}\`

            **Install with:**
            \`\`\`bash
            curl -fsSL https://safia.rocks/grove/install.sh | sh -s -- --pr ${prNumber}
            \`\`\`

            **Or if you already have grove installed:**
            \`\`\`bash
            grove self-update --pr ${prNumber}
            \`\`\`

            **Or download directly from [Actions Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId})**

            Available binaries:
            - \`grove-linux-x64\`
            - \`grove-linux-arm64\`
            - \`grove-darwin-x64\`
            - \`grove-darwin-arm64\`
            - \`grove-windows-x64.exe\``;

            // Check if a comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Grove PR Build Ready')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }
